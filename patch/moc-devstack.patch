From 3f10e823851ecaee8f8e87c3d02a2eb7daa445ae Mon Sep 17 00:00:00 2001
From: Huzefa Mandviwala <hzmandviwala@gmail.com>
Date: Thu, 21 Jun 2018 10:58:03 -0400
Subject: [PATCH] Added all changes to devstack patch branch

---
 .gitignore   |   1 -
 inc/python   |   3 ++
 lib/cinder   |   5 +++
 lib/glance   |   4 ++
 lib/horizon  |   4 ++
 lib/keystone |   5 +++
 lib/neutron  |   5 +++
 lib/nova     |   5 +++
 lib/swift    |   5 +++
 local.conf   | 124 +++++++++++++++++++++++++++++++++++++++++++++++++++
 stack.sh     |  10 +++++
 11 files changed, 170 insertions(+), 1 deletion(-)
 create mode 100644 local.conf

diff --git a/.gitignore b/.gitignore
index d2c127d0..80b3cf09 100644
--- a/.gitignore
+++ b/.gitignore
@@ -25,7 +25,6 @@ files/get-pip.py*
 files/ir-deploy*
 files/ironic-inspector*
 files/etcd*
-local.conf
 local.sh
 localrc
 proto
diff --git a/inc/python b/inc/python
index a127cdd6..1c06a5bc 100644
--- a/inc/python
+++ b/inc/python
@@ -366,6 +366,9 @@ function pip_install {
 }
 
 function pip_uninstall {
+    # Skip uninstall if offline
+    [[ "${OFFLINE}" = "True" ]] && return
+    
     local name=$1
     if [[ -n ${PIP_VIRTUAL_ENV:=} && -d ${PIP_VIRTUAL_ENV} ]]; then
         local cmd_pip=$PIP_VIRTUAL_ENV/bin/pip
diff --git a/lib/cinder b/lib/cinder
index 22c51680..3bdf73c3 100644
--- a/lib/cinder
+++ b/lib/cinder
@@ -441,6 +441,11 @@ function init_cinder {
 # install_cinder() - Collect source and prepare
 function install_cinder {
     git_clone $CINDER_REPO $CINDER_DIR $CINDER_BRANCH
+    
+    cd $CINDER_DIR
+    git reset --hard $CINDER_COMMIT
+    cd -
+    
     setup_develop $CINDER_DIR
     if [[ "$CINDER_ISCSI_HELPER" == "tgtadm" ]]; then
         install_package tgt
diff --git a/lib/glance b/lib/glance
index 7b42488b..8b4e4bff 100644
--- a/lib/glance
+++ b/lib/glance
@@ -329,6 +329,10 @@ function install_glance {
     fi
 
     git_clone $GLANCE_REPO $GLANCE_DIR $GLANCE_BRANCH
+    
+    cd $GLANCE_DIR
+    git reset --hard $GLANCE_COMMIT
+    cd -
 
     setup_develop $GLANCE_DIR
 }
diff --git a/lib/horizon b/lib/horizon
index becc5a0e..88321210 100644
--- a/lib/horizon
+++ b/lib/horizon
@@ -179,6 +179,10 @@ function install_horizon {
     install_apache_wsgi
 
     git_clone $HORIZON_REPO $HORIZON_DIR $HORIZON_BRANCH
+
+    cd $HORIZON_DIR
+    git reset --hard $HORIZON_COMMIT
+    cd -
 }
 
 # start_horizon() - Start running processes, including screen
diff --git a/lib/keystone b/lib/keystone
index 7c2da27b..6db66880 100644
--- a/lib/keystone
+++ b/lib/keystone
@@ -523,6 +523,11 @@ function install_keystone {
     fi
 
     git_clone $KEYSTONE_REPO $KEYSTONE_DIR $KEYSTONE_BRANCH
+    
+    cd $KEYSTONE_DIR
+    git reset --hard $KEYSTONE_COMMIT
+    cd -
+    
     setup_develop $KEYSTONE_DIR
 
     if is_service_enabled ldap; then
diff --git a/lib/neutron b/lib/neutron
index d4f4d6bb..e18eb5f7 100644
--- a/lib/neutron
+++ b/lib/neutron
@@ -348,6 +348,11 @@ function init_neutron_new {
 # install_neutron() - Collect source and prepare
 function install_neutron_new {
     git_clone $NEUTRON_REPO $NEUTRON_DIR $NEUTRON_BRANCH
+    
+    cd $NEUTRON_DIR
+    git reset --hard $NEUTRON_COMMIT
+    cd -
+
     setup_develop $NEUTRON_DIR
 
     # Install neutron-lib from git so we make sure we're testing
diff --git a/lib/nova b/lib/nova
index bc8b1432..0bcde07b 100644
--- a/lib/nova
+++ b/lib/nova
@@ -772,6 +772,11 @@ function install_nova {
     fi
 
     git_clone $NOVA_REPO $NOVA_DIR $NOVA_BRANCH
+    
+    cd $NOVA_DIR
+    git reset --hard $NOVA_COMMIT
+    cd -
+    
     setup_develop $NOVA_DIR
     sudo install -D -m 0644 -o $STACK_USER {$NOVA_DIR/tools/,/etc/bash_completion.d/}nova-manage.bash_completion
 }
diff --git a/lib/swift b/lib/swift
index 455740ea..c164fa1a 100644
--- a/lib/swift
+++ b/lib/swift
@@ -752,6 +752,11 @@ function init_swift {
 
 function install_swift {
     git_clone $SWIFT_REPO $SWIFT_DIR $SWIFT_BRANCH
+    
+    cd $SWIFT_DIR
+    git reset --hard $SWIFT_COMMIT
+    cd -
+    
     setup_develop $SWIFT_DIR
     if [ "$SWIFT_USE_MOD_WSGI" == "True" ]; then
         install_apache_wsgi
diff --git a/local.conf b/local.conf
new file mode 100644
index 00000000..e770625c
--- /dev/null
+++ b/local.conf
@@ -0,0 +1,124 @@
+[[local|localrc]]
+ADMIN_PASSWORD=Devstack1
+DATABASE_PASSWORD=$ADMIN_PASSWORD
+RABBIT_PASSWORD=$ADMIN_PASSWORD
+SERVICE_PASSWORD=$ADMIN_PASSWORD
+
+LOGFILE=$DEST/logs/stack.sh.log
+LOGDAYS=1
+SYSLOG=True
+
+# offline will be automatically turned on after a successful
+# install of devstack. this is done in order to avoid
+# installing new, incompatible versions of software.
+#
+# to install new versions of everything, comment the following
+# line. warning: this may break things
+#OFFLINE=True
+
+###################
+#
+#  Changing Openstack Service Source
+#
+###################
+
+# to use custom repos or branches for openstack service
+# uncomment relevant line(s) and insert the git url / exact branch name
+# 
+# to clone a specific commit, uncomment the relevant line
+# and insert the SHA of the desired commit
+# e.g. 7638417db6d59f3c431d3e1f261cc637155684cd
+#
+# ensure that the commit specified falls in the branch/repo indicated
+# or in the stable redhat repo if branch/repo not specified
+#
+# git repos must be manually retrieved by entering /opt/stack/$SERVICE
+# and executing `git pull`
+
+#CINDER_REPO=
+#CINDER_BRANCH=
+#CINDER_COMMIT=
+
+#GLANCE_REPO=
+#GLANCE_BRANCH=
+#GLANCE_COMMIT=
+
+#HORIZON_REPO=
+#HORIZON_BRANCH=
+#HORIZON_COMMIT=
+
+#KEYSTONE_REPO=
+#KEYSTONE_BRANCH=
+#KEYSTONE_COMMIT=
+
+#NEUTRON_REPO=
+#NEUTRON_BRANCH=
+#NEUTRON_COMMIT=
+
+#NOVA_REPO=
+#NOVA_BRANCH=
+#NOVA_COMMIT=
+
+#SWIFT_REPO=
+#SWIFT_BRANCH=
+#SWIFT_COMMIT=
+
+
+# uncomment if you change openstack service source
+# to re-clone git repos
+#RECLONE=yes
+
+###################
+
+
+enable_plugin rally https://github.com/hgibson1/rally.git profile
+enable_plugin panko https://git.openstack.org/openstack/panko stable/pike
+enable_plugin ceilometer https://git.openstack.org/openstack/ceilometer stable/pike
+enable_plugin osprofiler https://git.openstack.org/openstack/osprofiler stable/pike
+OSPROFILER_COLLECTOR=redis
+OSPROFILER_HMAC_KEYS=Devstack1
+CEILOMETER_NOTIFICATION_TOPICS=notifications,profiler
+ 
+[[post-config|/etc/nova/nova.conf]]
+[profiler]
+enabled = True
+connection_string = redis://localhost:6379
+hmac_keys = Devstack1
+trace_wsgi_transport = True
+trace_message_store = True
+trace_management_store = True
+trace_sqlalchemy = False
+ 
+[[post-config|/etc/keystone/keystone.conf]]
+[profiler]
+enabled = True
+connection_string = redis://localhost:6379
+hmac_keys = Devstack1
+trace_wsgi_transport = True
+trace_message_store = True
+trace_management_store = True
+trace_sqlalchemy = False
+
+[[post-config|/etc/cinder/cinder.conf]]
+[profiler]
+enabled = True
+connection_string = redis://localhost:6379
+hmac_keys = Devstack1
+trace_wsgi_transport = True
+trace_message_store = True
+trace_management_store = True
+trace_sqlalchemy = False
+
+[[post-config|/etc/glance/glance-api.conf]]
+[profiler]
+enabled = True
+connection_string = redis://localhost:6379
+hmac_keys = Devstack1
+trace_wsgi_transport = True
+trace_message_store = True
+trace_management_store = True
+trace_sqlalchemy = False
+
+[[post-config|/etc/ceilometer/ceilometer.conf]]
+[event]
+store_raw=info
diff --git a/stack.sh b/stack.sh
index 7412f52b..547ced38 100755
--- a/stack.sh
+++ b/stack.sh
@@ -756,6 +756,11 @@ save_stackenv $LINENO
 # attempt to apply any constraints to pip installs.
 git_clone $REQUIREMENTS_REPO $REQUIREMENTS_DIR $REQUIREMENTS_BRANCH
 
+# CentOS 7 compatability patch
+# Bump up python-libvirt upper constraint to 3.9
+echo "Updating requirements for python-libvirt."
+sed -i 's/libvirt-python===3.5.0/libvirt-python===3.9.0/' $REQUIREMENTS_DIR/upper-constraints.txt
+
 # Install package requirements
 # Source it so the entire environment is available
 echo_summary "Installing package prerequisites"
@@ -1558,6 +1563,11 @@ echo
 # Indicate how long this took to run (bash maintained variable ``SECONDS``)
 echo_summary "stack.sh completed in $SECONDS seconds."
 
+# Enable offline mode after a successful install in order to 
+# prevent updating software to incompatible versions
+echo "Enabling offline mode."
+echo "*Packages will not update on redeploys of stack unless you edit local.conf*"
+sed -i 's/#OFFLINE=True/OFFLINE=True/' /opt/stack/devstack/local.conf
 
 # Restore/close logging file descriptors
 exec 1>&3
-- 
2.17.1

